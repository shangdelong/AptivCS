<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('新增封样件的管理')" />
    <th:block th:include="include :: datetimepicker-css" />
    <th:block th:include="include :: bootstrap-fileinput-css"/>
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-sample-add">
            <div class="form-group">    
                <label class="col-sm-3 control-label is-required">物料名称：</label>
                <div class="col-sm-8">
                    <input name="sealedSample" class="form-control" type="text" required autocomplete="off">
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label is-required">8位码：</label>
                <div class="col-sm-8">
                    <input name="eightD" class="form-control" type="text" required autocomplete="off" data-rule="^[a-zA-Z\d]{8}+$" data-msg="请按照规则输入！" placeholder="例：A1234567">
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label is-required">样件位置：</label>
                <div class="col-sm-8">
                    <input name="sampleLocation" class="form-control" type="text" data-rule="^[A-Z]+[1-100]+[-]+[1-100]+[-]+[1-100]+$" data-msg="请按照(A-Z)(数字)-(数字)-(数字)的规则输入！" placeholder="例：A1-1-1" required autocomplete="off">
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">供应商：</label>
                <div class="col-sm-8">
                    <input name="supplier" class="form-control" type="text" autocomplete="off">
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">供应商号：</label>
                <div class="col-sm-8">
                    <input name="supplyHouse" class="form-control" type="text" autocomplete="off">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">业务：</label>
                <div class="col-sm-8">
                    <select name="business" class="form-control">
                        <option value="奔驰">奔驰</option>
                        <option value="大众">大众</option>
                        <option value="现代">现代</option>
                        <option value="长城">长城</option>
                    </select>
<!--                    <input name="business" class="form-control" type="text">-->
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">图纸日期：</label>
                <div class="col-sm-8">
                    <div class="input-group date">
                        <input name="drawingTime" class="form-control" placeholder="YYYY-MM-DD" type="text" autocomplete="off">
                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                    </div>
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">封样日期：</label>
                <div class="col-sm-8">
                    <div class="input-group date">
                        <input name="sealedSampleTime" class="form-control" placeholder="YYYY-MM-DD" type="text" autocomplete="off">
                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">样件复检周期(年)：</label>
                <div class="col-sm-8">
                    <select name="sampleIndate" class="form-control">
                        <option value="3">3</option>
                        <option value="5">5</option>

                    </select>
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">样件到期日期：</label>
                <div class="col-sm-8">
                    <div class="input-group date">
<!--                        <input name="sealedSampleDue" class="form-control" placeholder="yyyy-MM-dd" type="text" autocomplete="off">-->
<!--                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>-->
                    </div>
                    <input name="sealedSampleDue" class="form-control" type="text" autocomplete="off" readonly >
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">到今日还有(天)：</label>
                <div class="col-sm-8">
                    <input name="remainingTime" class="form-control" type="text">
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">实际复检日期：</label>
                <div class="col-sm-8">
                    <div class="input-group date">
                        <input name="recheckTime" class="form-control" placeholder="YYYY-MM-DD" type="text" autocomplete="off">
                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">备注：</label>
                <div class="col-sm-8">
                    <textarea name="notes" class="form-control"></textarea>
                </div>
            </div>
            <div class="form-group">    
                <label class="col-sm-3 control-label">上传的图片：</label>
                <div class="col-sm-8">
                    <input type="hidden" name="images">
                    <div class="file-loading">
                        <input class="form-control file-upload" id="images" name="file" type="file">
                    </div>
                </div>
            </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: datetimepicker-js" />
    <th:block th:include="include :: bootstrap-fileinput-js"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script th:inline="javascript">
        var cropper;
        var croppable = false;
        var prefix = ctx + "cs/sample"
        $("#form-sample-add").validate({
            focusCleanup: true
        });

        function submitHandler() {
            //比较图纸日期和封样件日期，封样件日期不能小于图纸日期，并且不能大于当前时间
            var drawingTime = $("input[name='drawingTime']").val();
            var start = new Date(drawingTime.replace("-", "/").replace("-", "/"));
            var sealedSampleTime = $("input[name='sealedSampleTime']").val();
            var mid = new Date(sealedSampleTime.replace("-", "/").replace("-", "/"));
            var nowTime = moment();
            if (mid < start || mid > nowTime) {
                alert("封样日期选择不符合要求，不能小于图纸时间且不能大于当前时间！");
                // return false;
                $('input[name=\'sealedSampleTime\']').val('');
            }else if ($.validate.form()) {
                $.operate.save(prefix + "/add", $('#form-sample-add').serialize());
            }
            // if ($.validate.form()) {
            //     $.operate.save(prefix + "/add", $('#form-sample-add').serialize());
            // }
        }

        //图纸日期
        $("input[name='drawingTime']").datetimepicker({
            format: "yyyy-mm-dd",
            minView: "month",
            autoclose: true
        });

        $(function () {
            //封样件时间
            $("input[name='sealedSampleTime']").datetimepicker({
                format: "yyyy-mm-dd",
                minView: "month",
                autoclose: true,
                minDate: 0
            });

            //选则日期和改变日期的时候触发事件
            $("input[name='sealedSampleTime'],select[name='sampleIndate']").change(function(){

                //比较图纸日期和封样件日期，封样件日期不能小于图纸日期，并且不能大于当前时间
                var drawingTime = $("input[name='drawingTime']").val();
                var start = new Date(drawingTime.replace("-", "/").replace("-", "/"));
                var sealedSampleTime = $("input[name='sealedSampleTime']").val();
                var mid = new Date(sealedSampleTime.replace("-", "/").replace("-", "/"));
                var nowTime = moment();
                if (mid < start || mid > nowTime) {
                    alert("封样日期选择不符合要求，不能小于图纸时间且不能大于当前系统时间！");
                    // return false;
                    $('input[name=\'sealedSampleTime\']').val('');
                }

                //根据封样日期和样件周期自动算出样件到期日期,通过改变  封样时间  触发样件到期时间。通过改变 样件周期 触发样件到期时间。
                var sealed_sample_time = $("input[name='sealedSampleTime']").val();//获取封样日期的时间
                var year = new Date(sealed_sample_time).getFullYear();// 获取封样日期年份
                var year_num = parseInt(year);//将字符串转化成int型
                var month = new Date(sealed_sample_time).getMonth()+1;// 获取封样日期月份，需要加1
                if (month<10){
                    month = '0'+month;
                }
                var day = new Date(sealed_sample_time).getDate();// 获取封样日期日期
                if (day<10){
                    day = '0'+day;
                }
                var sample_indate = $("select[name='sampleIndate']").val();//获取样件复检周期
                var sample_insate_num = parseInt(sample_indate);//转化成int型
                if (sealed_sample_time && sample_indate){//判断封样日期和样件复检周期是否有值
                    var new_year = year_num + sample_insate_num;//年份加上周期
                    var new_year_string = new_year.toString();
                    var sealed_sample_due = `${new_year_string}-${month}-${day}`// 使用模板字符串将年月日拼接成日期字符串
                    $("input[name='sealedSampleDue']").val(sealed_sample_due);//更新到样件到期日期
                }

                //现在时间距样件到期时间有多少天
                var startDate = moment().format('YYYY-MM-DD');//获取当前时间
                console.log(startDate);
                var endDate = moment($("input[name='sealedSampleDue']").val());//获取样件到期时间
                console.log(endDate);
                var days = endDate.diff(startDate, 'days');//使用 diff() 方法来计算指定日期和当前日期之间的天数差
                console.log('现在到样件到期日期还有 ' + days + ' 天');
                $("input[name='remainingTime']").val(days);//更新到距今还有多少天输入框
            })

            //根据封样日期和样件周期自动算出样件到期日期,通过改变 样件周期 触发样件到期时间
            // $("select[name='sampleIndate']").change(function(){
            //     console.log('4444');
            //     var sealed_sample_time = $("input[name='sealedSampleTime']").val();//获取封样日期的时间
            //     var year = new Date(sealed_sample_time).getFullYear();// 获取封样日期年份
            //     var year_num = parseInt(year);//将字符串转化成int型
            //     var month = new Date(sealed_sample_time).getMonth()+1;// 获取封样日期月份，需要加1
            //     if (month<10){
            //         month = '0'+month;
            //     }
            //     var day = new Date(sealed_sample_time).getDate();// 获取封样日期日期
            //     if (day<10){
            //         day = '0'+day;
            //     }
            //     var sample_indate = $("select[name='sampleIndate']").val();//获取样件复检周期
            //     var sample_insate_num = parseInt(sample_indate);//转化成int型
            //     if (sealed_sample_time && sample_indate){//判断封样日期和样件复检周期是否有值
            //         var new_year = year_num + sample_insate_num;//年份加上周期
            //         var new_year_string = new_year.toString();
            //         var sealed_sample_due = `${new_year_string}-${month}-${day}`// 使用模板字符串将年月日拼接成日期字符串
            //         $("input[name='sealedSampleDue']").val(sealed_sample_due);//更新到样件到期日期
            //     }
            // })

        });

        $(function() {
            $('input[data-rule]').on('focusout', function() {
                var $this = $(this);
                var rule = new RegExp($this.data('rule'));
                if (!rule.test($this.val())) {
                    alert($this.data('msg'));
                }
            });
        });


        // $("input[name='sealedSampleDue']").datetimepicker({
        //     format: "yyyy-mm-dd",
        //     minView: "month",
        //     autoclose: true
        // });

        //复检时间
        $("input[name='recheckTime']").datetimepicker({
            format: "yyyy-mm-dd",
            minView: "month",
            autoclose: true
        });

            $(".file-upload").fileinput({
                uploadUrl: ctx + 'common/upload',
                maxFileCount: 1,
                autoReplace: true
            }).on('fileuploaded', function (event, data, previewId, index) {
                $("input[name='" + event.currentTarget.id + "']").val(data.response.url)
            }).on('fileremoved', function (event, id, index) {
                $("input[name='" + event.currentTarget.id + "']").val('')
            })

    </script>
</body>
</html>